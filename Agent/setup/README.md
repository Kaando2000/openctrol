# Openctrol Agent Setup

This folder contains everything needed to build, publish, and install the Openctrol Agent.

## Quick Start

### For GitHub Users (Downloaded Release)

If you downloaded a release ZIP:

1. **Extract the ZIP** to a folder (e.g., `C:\Openctrol`)
2. **Open PowerShell as Administrator** (Right-click → "Run as Administrator")
3. **Navigate to the setup folder**:
   ```powershell
   cd C:\Openctrol\Agent\setup
   ```
4. **Run the setup script**:
   ```powershell
   powershell -ExecutionPolicy Bypass -File .\setup.ps1
   ```

The setup script will:
- Build and publish the agent (if binaries not present)
- Uninstall any existing version
- Install the new version
- Verify the installation

### For Developers (Building from Source)

If you're building from source:

1. **Ensure you have .NET 8 SDK** installed
2. **Open PowerShell as Administrator**
3. **Navigate to the setup folder**:
   ```powershell
   cd Agent\setup
   ```
4. **Run the setup script**:
   ```powershell
   powershell -ExecutionPolicy Bypass -File .\setup.ps1
   ```

The script will automatically:
- Build the solution
- Publish to `setup/bin`
- Install the service

## Setup Script Options

```powershell
# Basic installation (default port 44325)
.\setup.ps1

# Custom port and API key
.\setup.ps1 -Port 8080 -ApiKey "my-secret-key"

# Use existing binaries (skip build)
.\setup.ps1 -SkipBuild

# Upgrade existing installation (skip uninstall)
.\setup.ps1 -SkipUninstall

# With HTTPS
.\setup.ps1 -UseHttps -CertPath "C:\certs\cert.pfx" -CertPassword "password"

# Skip firewall rule creation
.\setup.ps1 -CreateFirewallRule:$false
```

## Folder Structure

```
Agent/setup/
├── setup.ps1          # Main setup script (builds, publishes, installs)
├── install.ps1        # Installation helper (used internally by setup.ps1)
├── uninstall.ps1      # Uninstallation script
├── bin/               # Published binaries (generated by setup.ps1)
│   └── Openctrol.Agent.exe
└── README.md          # This file
```

**Note**: `install.ps1` is used internally by `setup.ps1` to handle the actual installation steps (copying files, creating service, etc.). You typically only need to run `setup.ps1`, which orchestrates the entire process. The `install.ps1` script can also be used standalone if you already have published binaries and just want to install them.

## Portable Distribution

After running `setup.ps1`, the `setup` folder becomes **portable**:

- ✅ All binaries are in `setup/bin/`
- ✅ All scripts are self-contained
- ✅ Can be distributed independently
- ✅ No external dependencies required

You can:
- Zip the entire `setup` folder
- Distribute it to other machines
- Run `setup.ps1` on any Windows machine (with .NET 8 runtime if binaries not pre-built)

## Manual Installation

If you prefer to install manually:

```powershell
# 1. Build and publish (if not already done)
cd ..\src
dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -o ..\setup\bin

# 2. Install using the install script directly
cd ..\setup
.\install.ps1 -SourcePath .\bin
```

## Uninstallation

To completely remove the agent:

```powershell
.\uninstall.ps1

# To also remove configuration and logs:
.\uninstall.ps1 -RemoveProgramData
```

## Troubleshooting

### "Could not find Openctrol.Agent.exe"

- Run `setup.ps1` without `-SkipBuild` to build the project first
- Ensure you have .NET 8 SDK installed
- Check that the project structure is correct

### "Service cannot be started"

- Check Event Log: `Get-EventLog -LogName Application -Source OpenctrolAgent -Newest 10`
- Verify port is not in use: `netstat -ano | findstr :44325`
- Check configuration file: `C:\ProgramData\Openctrol\config.json`

### "Access Denied" errors

- Ensure you're running PowerShell as Administrator
- Check that the service account has proper permissions
- Verify token impersonation is working (check logs for Session 0 isolation issues)

## Requirements

- **Windows 10/11** or Windows Server 2016+
- **.NET 8 Runtime** (if using pre-built binaries)
- **.NET 8 SDK** (if building from source)
- **Administrator privileges** (for service installation)

## Security Notes

- The agent runs as **LocalSystem** (required for desktop access)
- Configuration files have restrictive permissions (Administrators and SYSTEM only)
- API keys are auto-generated using cryptographically secure random number generation
- Certificate passwords are encrypted using Windows DPAPI (LocalMachine scope)
- The agent only listens on the local network (not exposed to internet)

## Support

For issues, questions, or contributions:
- Check the main [README.md](../../README.md)
- Review [docs/GUIDE.md](../../docs/GUIDE.md)
- See [docs/ARCHITECTURE.md](../../docs/ARCHITECTURE.md) for detailed documentation
